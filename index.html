<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Transaction Request | Acornia</title>
    <!-- Raleway Font - Same as Acornia website -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- ZOHO CRM SDK (Changed from Creator SDK) -->
    <script src="https://live.zwidgets.com/js-sdk/1.2/ZohoEmbededAppSDK.min.js"></script>

    <style>
        /* ========================================
           ACORNIA BRAND DESIGN SYSTEM
        ======================================== */
        :root {
            --primary: #FA981D;
            --primary-hover: #e88a15;
            --primary-light: rgba(250, 152, 29, 0.1);
            --text-dark: #050E1C;
            --text-body: #4F4F4F;
            --text-light: #6c757d;
            --bg-white: #ffffff;
            --bg-light: #F1F5FD;
            --bg-accent: #B2DEF2;
            --success: #28a745;
            --warning: #ffc107;
            --error: #dc3545;
            --border: #e0e6ed;
            --shadow: 0 5px 30px rgba(0,0,0,0.08);
            --radius: 5px;
            --radius-lg: 10px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Raleway', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4fd 100%);
            color: var(--text-body);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-overlay.hidden { display: none; }
        .loading-spinner {
            width: 50px; height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loading-text { margin-top: 15px; font-weight: 600; color: var(--text-dark); }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Header */
        .header {
            background: var(--bg-white);
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header-inner {
            max-width: 1200px;
            margin: 0 auto;
            padding: 15px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo { height: 50px; }

        /* Page Title */
        .page-title-section {
            background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-accent) 100%);
            padding: 40px 30px;
            text-align: center;
        }
        .page-title-section h1 {
            font-size: 36px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
        }
        .page-title-section p { font-size: 16px; color: var(--text-body); }

        /* Main Container */
        .main-container {
            max-width: 1000px;
            margin: -30px auto 50px;
            padding: 0 20px;
        }
        .form-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* Form Sections */
        .form-section {
            padding: 30px;
            border-bottom: 1px solid var(--border);
        }
        .form-section:last-child { border-bottom: none; }
        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }
        .section-number {
            width: 36px; height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        .section-title { font-size: 22px; font-weight: 600; color: var(--text-dark); }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-row.single { grid-template-columns: 1fr; }
        .form-group { display: flex; flex-direction: column; }
        label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        label .required { color: var(--error); }
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-family: 'Raleway', sans-serif;
            font-size: 14px;
            color: var(--text-dark);
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        input:disabled { background: var(--bg-light); color: var(--text-light); }
        .helper-text { font-size: 12px; color: var(--text-light); margin-top: 5px; }

        /* Autocomplete */
        .autocomplete-wrapper { position: relative; }
        .autocomplete-dropdown {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: white;
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        .autocomplete-dropdown.show { display: block; }
        .autocomplete-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .autocomplete-item:hover { background: var(--bg-light); }
        .autocomplete-item .name { font-weight: 600; color: var(--text-dark); }
        .autocomplete-item .pan { font-size: 12px; color: var(--text-light); }
        .autocomplete-item .highlight { background: #fff3cd; padding: 0 2px; border-radius: 2px; }
        .no-results { padding: 12px 15px; color: var(--text-light); font-style: italic; }

        /* PAN Status */
        .pan-wrapper { position: relative; }
        .pan-wrapper input { padding-right: 40px; }
        .pan-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
        }
        .pan-status.loading { color: var(--primary); animation: spin 1s linear infinite; }
        .pan-status.valid { color: var(--success); }
        .pan-status.invalid { color: var(--error); }

        /* Investor Card */
        .investor-card {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-top: 20px;
            display: none;
        }
        .investor-card.visible { display: block; }
        .investor-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        .status-validated { background: #d4edda; color: #155724; }
        .status-registered { background: #fff3cd; color: #856404; }
        .status-onhold { background: #f8d7da; color: #721c24; }
        .status-notfound { background: #e9ecef; color: #495057; }
        .status-new { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .status-existing { background: #cce5ff; color: #004085; }

        /* New Investor Fields */
        .new-investor-fields {
            background: #fff8e6;
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            border: 1px solid #ffc107;
        }

        /* Platform Tags */
        .platform-section { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); }
        .platform-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .platform-tag { padding: 5px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .platform-active { background: var(--success); color: white; }
        .platform-inactive { background: #e9ecef; color: #6c757d; }

        /* Investor Details Grid */
        .investor-details-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .detail-item { background: white; padding: 12px 15px; border-radius: var(--radius); }
        .detail-label { font-size: 11px; color: var(--text-light); text-transform: uppercase; margin-bottom: 4px; }
        .detail-value { font-size: 14px; color: var(--text-dark); font-weight: 500; }

        /* Transaction Cards */
        .transaction-card {
            background: var(--bg-light);
            border-radius: var(--radius-lg);
            margin-bottom: 15px;
            overflow: hidden;
        }
        .transaction-header {
            background: linear-gradient(135deg, var(--text-dark) 0%, #1a2a3a 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .transaction-title { font-weight: 600; font-size: 15px; }
        .btn-remove {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 28px; height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
        }
        .btn-remove:hover { background: var(--error); }
        .transaction-body { padding: 20px; }
        .btn-add-transaction {
            width: 100%;
            padding: 18px;
            background: white;
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            color: var(--text-light);
            font-family: 'Raleway', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-add-transaction:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary-light);
        }

        /* Tasks */
        .task-list { display: flex; flex-direction: column; gap: 12px; }
        .task-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: white;
            padding: 15px 20px;
            border-radius: var(--radius);
            border-left: 4px solid var(--primary);
        }
        .task-icon {
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        .task-icon.new { background: #f8d7da; color: #721c24; }
        .task-icon.kyc { background: #fff3cd; color: #856404; }
        .task-icon.platform { background: #cce5ff; color: #004085; }
        .task-icon.txn { background: #d4edda; color: #155724; }
        .task-info { flex: 1; }
        .task-name { font-weight: 600; font-size: 14px; color: var(--text-dark); }
        .task-desc { font-size: 12px; color: var(--text-light); margin-top: 2px; }
        .task-assign { min-width: 200px; }
        .task-assign select { padding: 10px 12px; font-size: 13px; }
        .empty-tasks { text-align: center; padding: 40px; color: var(--text-light); }

        /* Buttons */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            padding: 25px 30px;
            background: var(--bg-light);
        }
        .btn {
            padding: 14px 35px;
            border-radius: var(--radius);
            font-family: 'Raleway', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(250, 152, 29, 0.4);
        }
        .btn-secondary {
            background: white;
            color: var(--text-dark);
            border: 1px solid var(--border);
        }

        /* Footer */
        .footer {
            background: var(--text-dark);
            color: rgba(255,255,255,0.7);
            text-align: center;
            padding: 20px;
            font-size: 13px;
        }
        .footer a { color: var(--primary); text-decoration: none; }

        /* Responsive */
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
            .investor-details-grid { grid-template-columns: repeat(2, 1fr); }
            .task-item { flex-direction: column; align-items: flex-start; }
            .task-assign { width: 100%; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Connecting to Zoho CRM...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-inner">
            <img src="https://acornf.com/assets/images/logo-footer.png" alt="Acornia" class="logo">
        </div>
    </header>

    <!-- Page Title -->
    <section class="page-title-section">
        <h1>New Transaction Request</h1>
        <p>Submit a new mutual fund transaction for processing</p>
    </section>

    <!-- Main Form -->
    <main class="main-container">
        <div class="form-card">

            <!-- Section 1: Investor Details -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-number">1</span>
                    <h2 class="section-title">Investor Details</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Investor Name <span class="required">*</span></label>
                        <div class="autocomplete-wrapper">
                            <input type="text" id="investorNameInput" placeholder="Start typing investor name..." autocomplete="off">
                            <div class="autocomplete-dropdown" id="nameDropdown"></div>
                        </div>
                        <span class="helper-text">Type to search existing investors in CRM</span>
                    </div>
                    <div class="form-group">
                        <label>PAN Number <span class="required">*</span></label>
                        <div class="pan-wrapper">
                            <input type="text" id="investorPanInput" placeholder="e.g., ABCDE1234F" maxlength="10" style="text-transform: uppercase;" autocomplete="off">
                            <span class="pan-status" id="panStatus"></span>
                        </div>
                        <span class="helper-text" id="panHelperText">Enter 10-character PAN to verify</span>
                    </div>
                </div>

                <!-- Investor Details Card -->
                <div class="investor-card" id="investorCard">
                    <div class="investor-header">
                        <div id="investorTypeBadge" class="status-badge status-existing">Existing Investor</div>
                        <div id="kycBadge" class="status-badge status-validated">KYC Validated</div>
                    </div>

                    <!-- For NEW investors -->
                    <div class="new-investor-fields" id="newInvestorFields" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Email <span class="required">*</span></label>
                                <input type="email" id="newInvestorEmail" placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label>Phone <span class="required">*</span></label>
                                <input type="tel" id="newInvestorPhone" placeholder="+91 98765 43210">
                            </div>
                        </div>
                    </div>

                    <!-- For EXISTING investors -->
                    <div class="existing-investor-details" id="existingInvestorDetails">
                        <div class="investor-details-grid">
                            <div class="detail-item">
                                <div class="detail-label">Email</div>
                                <div class="detail-value" id="investorEmail">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Phone</div>
                                <div class="detail-value" id="investorPhone">-</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Existing Folios</div>
                                <div class="detail-value" id="investorFolios">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Platform Registration Status -->
                    <div class="platform-section">
                        <div class="detail-label" style="margin-bottom: 10px;">Platform Registrations</div>
                        <div class="platform-tags" id="platformTags">
                            <span class="platform-tag platform-inactive">NSE ✗</span>
                            <span class="platform-tag platform-inactive">BSE ✗</span>
                            <span class="platform-tag platform-inactive">MFU ✗</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Transactions -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-number">2</span>
                    <h2 class="section-title">Transactions</h2>
                </div>

                <div id="transactionsList">
                    <div class="transaction-card" data-id="1">
                        <div class="transaction-header">
                            <span class="transaction-title">Transaction #1</span>
                            <button class="btn-remove" onclick="removeTransaction(1)">&times;</button>
                        </div>
                        <div class="transaction-body">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Transaction Type <span class="required">*</span></label>
                                    <select id="txnType1" onchange="onTxnTypeChange(1)">
                                        <option value="">-- Select Type --</option>
                                        <option value="Purchase">Purchase</option>
                                        <option value="SIP Registration">SIP Registration</option>
                                        <option value="SIP Installment">SIP Installment</option>
                                        <option value="Redemption">Redemption</option>
                                        <option value="Switch">Switch</option>
                                        <option value="SWP">SWP</option>
                                        <option value="STP">STP</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Amount (INR) <span class="required">*</span></label>
                                    <input type="number" id="txnAmount1" placeholder="Enter amount" onchange="updateTasks()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>AMC <span class="required">*</span></label>
                                    <select id="txnAmc1" onchange="onAmcChange(1)">
                                        <option value="">-- Select AMC --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Scheme Name <span class="required">*</span></label>
                                    <input type="text" id="txnScheme1" placeholder="Enter scheme name" onchange="updateTasks()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Payout Mode</label>
                                    <select id="txnPayout1">
                                        <option value="Growth">Growth</option>
                                        <option value="IDCW Payout">IDCW Payout</option>
                                        <option value="IDCW Reinvestment">IDCW Reinvestment</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Platform</label>
                                    <select id="txnPlatform1">
                                        <option value="NSE">NSE</option>
                                        <option value="BSE">BSE</option>
                                        <option value="MFU">MFU</option>
                                        <option value="Direct AMC">Direct AMC</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row" id="sipRow1" style="display: none;">
                                <div class="form-group" id="sipDateGroup1">
                                    <label>SIP Date</label>
                                    <select id="txnSipDate1">
                                        <option value="1">1st</option>
                                        <option value="5">5th</option>
                                        <option value="10">10th</option>
                                        <option value="15">15th</option>
                                        <option value="20">20th</option>
                                        <option value="25">25th</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="btn-add-transaction" onclick="addTransaction()">
                    <span>+</span> Add Another Transaction
                </button>
            </div>

            <!-- Section 3: Task Assignment -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-number">3</span>
                    <h2 class="section-title">Task Assignment</h2>
                </div>
                <div class="task-list" id="tasksList">
                    <div class="empty-tasks">Select an investor and add transactions to see tasks</div>
                </div>
            </div>

            <!-- Section 4: Notes -->
            <div class="form-section">
                <div class="section-header">
                    <span class="section-number">4</span>
                    <h2 class="section-title">Additional Notes</h2>
                </div>
                <div class="form-row single">
                    <div class="form-group">
                        <textarea id="notes" rows="4" placeholder="Any special instructions for the operations team..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="resetForm()">Reset Form</button>
                <button class="btn btn-primary" onclick="submitForm()">Submit Request</button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <p>AMFI Registered Mutual Fund Distributor | ARN: 192746</p>
        <p>&copy; 2024 <a href="https://acornf.com/">Acornia Investment Services</a></p>
        <div id="debugInfo" style="margin-top: 15px; padding: 10px; background: #1a2a3a; border-radius: 5px; text-align: left; font-size: 11px; font-family: monospace;">
            <strong style="color: #FA981D;">Debug Info:</strong>
            <span id="debugText" style="color: #aaa;"> Loading...</span>
        </div>
    </footer>

    <script>
        // ========================================
        // CONFIGURATION - CRM MODULE NAMES
        // ========================================
        const CONFIG = {
            // CRM Module API names
            modules: {
                investors: "Investors",
                transactions: "MF_Transactions"
            },
            // Field API names - Verified from CRM module fields
            fields: {
                investor: {
                    pan: "PAN_Number",
                    name: "Name",           // System primary field (Investor Name)
                    fullName: "Full_Name",  // Custom field with clean name
                    email: "Email",
                    phone: "Phone",
                    kycStatus: "KYC_Status",
                    nseReg: "NSE_Registered",
                    bseReg: "BSE_Registered",
                    mfuReg: "MFU_Registered",
                    assignedRm: "Owner"  // Default owner field
                },
                transaction: {
                    investor: "Investor",
                    type: "Transaction_Type",
                    amount: "Amount",
                    scheme: "Scheme_Name",
                    amc: "AMC",
                    platform: "Platform",
                    payout: "Payout_Mode",
                    status: "Status",
                    priority: "Priority",
                    assignedRm: "Assigned_RM",
                    assignedOps: "Assigned_Ops",
                    sipDate: "SIP_Date",
                    notes: "Transaction_Notes"
                }
            }
        };

        // ========================================
        // DATA STORAGE
        // ========================================
        let investors = [];
        let crmUsers = [];
        let selectedInvestor = null;
        let isNewInvestor = false;
        let transactionCount = 1;

        // AMC List
        const amcList = [
            "HDFC Mutual Fund", "ICICI Prudential", "SBI Mutual Fund",
            "Axis Mutual Fund", "Kotak Mutual Fund", "Nippon India",
            "DSP Mutual Fund", "Aditya Birla Sun Life", "Tata Mutual Fund",
            "UTI Mutual Fund", "Mirae Asset", "PPFAS / Parag Parikh"
        ];

        // ========================================
        // ZOHO CRM SDK INITIALIZATION
        // ========================================
        let sdkInitialized = false;

        // Timeout - if SDK doesn't connect in 10 seconds, show form anyway
        setTimeout(function() {
            if (!sdkInitialized) {
                console.warn("SDK timeout - showing form in demo mode");
                setLoadingText("Running in demo mode (CRM not connected)");
                setTimeout(function() {
                    hideLoading();
                    populateAmcDropdowns();
                }, 1000);
            }
        }, 10000);

        ZOHO.embeddedApp.on("PageLoad", function(data) {
            console.log("CRM Widget loaded", data);
            sdkInitialized = true;
            setLoadingText("Loading data from CRM...");
            loadAllData();
        });

        ZOHO.embeddedApp.init().then(function() {
            console.log("Zoho CRM SDK initialized successfully");
        }).catch(function(error) {
            console.error("SDK init error:", error);
            setLoadingText("SDK error - showing form in demo mode");
            setTimeout(function() {
                hideLoading();
                populateAmcDropdowns();
            }, 1000);
        });

        function setLoadingText(text) {
            document.getElementById('loadingText').textContent = text;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showLoading(text) {
            setLoadingText(text || "Processing...");
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        // ========================================
        // LOAD DATA FROM ZOHO CRM (Direct API)
        // ========================================
        async function loadAllData() {
            try {
                await Promise.all([
                    loadInvestors(),
                    loadCRMUsers()
                ]);
                populateAmcDropdowns();
                updateDebugInfo();
                hideLoading();
                console.log("All data loaded successfully");
            } catch (error) {
                console.error("Load error:", error);
                updateDebugInfo("Error: " + error.message);
                hideLoading();
            }
        }

        function updateDebugInfo(errorMsg) {
            const debugEl = document.getElementById('debugText');
            if (errorMsg) {
                debugEl.textContent = errorMsg;
                debugEl.style.color = '#dc3545';
            } else {
                const investorNames = investors.map(i => i.name).join(', ') || 'None';
                const userNames = crmUsers.map(u => u.name).join(', ') || 'None';
                debugEl.innerHTML = `Module: ${CONFIG.modules.investors} | Investors: ${investors.length} (${investorNames}) | Users: ${crmUsers.length} (${userNames})`;
                debugEl.style.color = '#28a745';
            }
        }

        // Load Investors from CRM
        async function loadInvestors() {
            try {
                console.log(`Loading investors from module: ${CONFIG.modules.investors}`);
                console.log(`Using field names:`, CONFIG.fields.investor);

                const response = await ZOHO.CRM.API.getRecords({
                    Entity: CONFIG.modules.investors,
                    sort_order: "asc",
                    per_page: 200
                });

                console.log("getRecords response:", JSON.stringify(response));

                if (response && response.data) {
                    const F = CONFIG.fields.investor;
                    investors = response.data.map(record => {
                        console.log("Processing record:", JSON.stringify(record));
                        // Use Full_Name if available (cleaner), fallback to Name (system field)
                        const displayName = record[F.fullName] || record[F.name] || record.Name || '';
                        return {
                            id: record.id,
                            name: displayName,
                            email: record[F.email] || '',
                            phone: record[F.phone] || '',
                            pan: record[F.pan] || '',
                            kycStatus: record[F.kycStatus] || 'Not Verified',
                            nse: record[F.nseReg] === true,
                            bse: record[F.bseReg] === true,
                            mfu: record[F.mfuReg] === true
                        };
                    });
                    console.log(`Loaded ${investors.length} investors:`, investors.map(i => i.name));
                } else {
                    console.log("No data in response or response is null");
                    investors = [];
                }
            } catch (error) {
                console.error("Error loading investors:", error);
                console.error("Error details:", JSON.stringify(error));
                investors = [];
            }
        }

        // Load CRM Users for task assignment
        async function loadCRMUsers() {
            try {
                console.log("Loading CRM users...");

                // Method 1: Try getAllUsers
                const response = await ZOHO.CRM.API.getAllUsers({
                    Type: "AllUsers"
                });
                console.log("getAllUsers response:", JSON.stringify(response));

                if (response && response.users && response.users.length > 0) {
                    crmUsers = response.users.map(user => ({
                        id: user.id,
                        name: user.full_name || user.name || user.email,
                        email: user.email
                    }));
                    console.log(`Loaded ${crmUsers.length} users from getAllUsers`);
                } else {
                    // Method 2: Try getting current user as fallback
                    console.log("No users from getAllUsers, trying getCurrentUser...");
                    try {
                        const currentUser = await ZOHO.CRM.CONFIG.getCurrentUser();
                        console.log("getCurrentUser response:", JSON.stringify(currentUser));
                        if (currentUser && currentUser.users && currentUser.users.length > 0) {
                            crmUsers = currentUser.users.map(user => ({
                                id: user.id,
                                name: user.full_name || user.name || "Current User",
                                email: user.email
                            }));
                            console.log(`Loaded current user: ${crmUsers[0].name}`);
                        }
                    } catch (e) {
                        console.error("getCurrentUser error:", e);
                    }
                }

                // Fallback: Add placeholder if still no users
                if (crmUsers.length === 0) {
                    console.log("No users loaded, adding Ops Team placeholder");
                    crmUsers = [
                        { id: "ops_team", name: "Operations Team", email: "" }
                    ];
                }
            } catch (error) {
                console.error("Error loading users:", error);
                // Fallback
                crmUsers = [
                    { id: "ops_team", name: "Operations Team", email: "" }
                ];
            }
        }

        // Populate AMC dropdowns
        function populateAmcDropdowns() {
            document.querySelectorAll('[id^="txnAmc"]').forEach(select => {
                select.innerHTML = '<option value="">-- Select AMC --</option>';
                amcList.forEach(amc => {
                    select.innerHTML += `<option value="${amc}">${amc}</option>`;
                });
            });
        }

        // ========================================
        // NAME AUTOCOMPLETE
        // ========================================
        const nameInput = document.getElementById('investorNameInput');
        const nameDropdown = document.getElementById('nameDropdown');
        const panInputEl = document.getElementById('investorPanInput');
        const panStatus = document.getElementById('panStatus');
        const panHelperText = document.getElementById('panHelperText');

        nameInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();

            if (query.length < 2) {
                nameDropdown.classList.remove('show');
                return;
            }

            const matches = investors.filter(c => c.name.toLowerCase().includes(query));

            if (matches.length > 0) {
                let html = '';
                matches.forEach(c => {
                    const highlighted = c.name.replace(
                        new RegExp(`(${escapeRegExp(query)})`, 'gi'),
                        '<span class="highlight">$1</span>'
                    );
                    html += `
                        <div class="autocomplete-item" onclick="selectInvestorFromDropdown('${c.id}')">
                            <div class="name">${highlighted}</div>
                            <div class="pan">PAN: ${c.pan || 'Not set'}</div>
                        </div>
                    `;
                });
                nameDropdown.innerHTML = html;
            } else {
                nameDropdown.innerHTML = '<div class="no-results">No matching investors. Enter PAN to add new.</div>';
            }
            nameDropdown.classList.add('show');
        });

        function escapeRegExp(s) { return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.autocomplete-wrapper')) {
                nameDropdown.classList.remove('show');
            }
        });

        function selectInvestorFromDropdown(investorId) {
            const investor = investors.find(c => c.id === investorId);
            if (investor) {
                nameInput.value = investor.name;
                panInputEl.value = investor.pan;
                nameDropdown.classList.remove('show');
                panStatus.textContent = '✓';
                panStatus.className = 'pan-status valid';
                panHelperText.textContent = 'Investor found in CRM';
                panHelperText.style.color = '#28a745';
                selectExistingInvestor(investor);
            }
        }

        // ========================================
        // PAN FIELD
        // ========================================
        panInputEl.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });

        panInputEl.addEventListener('blur', function() {
            const pan = this.value.trim().toUpperCase();
            if (pan.length === 0) return;

            const panRegex = /^[A-Z]{5}[0-9]{4}[A-Z]{1}$/;
            if (!panRegex.test(pan)) {
                panStatus.textContent = '✗';
                panStatus.className = 'pan-status invalid';
                panHelperText.textContent = 'Invalid PAN format';
                panHelperText.style.color = '#dc3545';
                return;
            }

            panStatus.textContent = '⟳';
            panStatus.className = 'pan-status loading';
            panHelperText.textContent = 'Searching CRM...';

            setTimeout(() => processPanLookup(pan), 300);
        });

        function processPanLookup(pan) {
            const existing = investors.find(c => c.pan === pan);

            if (existing) {
                panStatus.textContent = '✓';
                panStatus.className = 'pan-status valid';
                panHelperText.textContent = 'Investor found in CRM';
                panHelperText.style.color = '#28a745';

                if (nameInput.value.toLowerCase() !== existing.name.toLowerCase()) {
                    nameInput.value = existing.name;
                }
                selectExistingInvestor(existing);
            } else {
                panStatus.textContent = '!';
                panStatus.className = 'pan-status';
                panStatus.style.color = '#ffc107';
                panHelperText.textContent = 'New investor - will be added to CRM';
                panHelperText.style.color = '#856404';

                handleNewInvestor(nameInput.value.trim(), pan);
            }
        }

        // ========================================
        // INVESTOR SELECTION LOGIC
        // ========================================
        function selectExistingInvestor(investor) {
            selectedInvestor = investor;
            isNewInvestor = false;

            document.getElementById('investorCard').classList.add('visible');
            document.getElementById('investorTypeBadge').textContent = '✓ Existing Investor';
            document.getElementById('investorTypeBadge').className = 'status-badge status-existing';

            document.getElementById('existingInvestorDetails').style.display = 'block';
            document.getElementById('newInvestorFields').style.display = 'none';

            document.getElementById('investorEmail').textContent = investor.email || '-';
            document.getElementById('investorPhone').textContent = investor.phone || '-';
            document.getElementById('investorFolios').textContent = investor.folios || 'No existing folios';

            setKycBadge(document.getElementById('kycBadge'), investor.kycStatus);

            document.getElementById('platformTags').innerHTML = `
                <span class="platform-tag ${investor.nse ? 'platform-active' : 'platform-inactive'}">NSE ${investor.nse ? '✓' : '✗'}</span>
                <span class="platform-tag ${investor.bse ? 'platform-active' : 'platform-inactive'}">BSE ${investor.bse ? '✓' : '✗'}</span>
                <span class="platform-tag ${investor.mfu ? 'platform-active' : 'platform-inactive'}">MFU ${investor.mfu ? '✓' : '✗'}</span>
            `;

            updateTasks();
        }

        function handleNewInvestor(name, pan) {
            isNewInvestor = true;
            selectedInvestor = {
                id: null,
                name: name || "New Investor",
                pan: pan,
                email: "", phone: "",
                kycStatus: "Not Found",
                nse: false, bse: false, mfu: false
            };

            document.getElementById('investorCard').classList.add('visible');
            document.getElementById('investorTypeBadge').textContent = '⚠ NEW INVESTOR';
            document.getElementById('investorTypeBadge').className = 'status-badge status-new';

            document.getElementById('existingInvestorDetails').style.display = 'none';
            document.getElementById('newInvestorFields').style.display = 'block';

            document.getElementById('newInvestorEmail').value = '';
            document.getElementById('newInvestorPhone').value = '';

            setKycBadge(document.getElementById('kycBadge'), 'Not Found');

            document.getElementById('platformTags').innerHTML = `
                <span class="platform-tag platform-inactive">NSE ✗</span>
                <span class="platform-tag platform-inactive">BSE ✗</span>
                <span class="platform-tag platform-inactive">MFU ✗</span>
            `;

            updateTasks();
        }

        function setKycBadge(badge, status) {
            const map = {
                'Validated': { class: 'status-validated', text: 'KYC Validated ✓' },
                'Registered': { class: 'status-registered', text: 'KYC Registered' },
                'On-Hold': { class: 'status-onhold', text: 'KYC On-Hold ⚠' },
                'Not Found': { class: 'status-notfound', text: 'KYC Not Found ✗' }
            };
            const info = map[status] || map['Not Found'];
            badge.className = 'status-badge ' + info.class;
            badge.textContent = info.text;
        }

        // ========================================
        // TRANSACTIONS
        // ========================================
        function onAmcChange(id) {
            updateTasks();
        }

        function onTxnTypeChange(id) {
            const type = document.getElementById('txnType' + id).value;
            const sipRow = document.getElementById('sipRow' + id);
            if (sipRow) {
                sipRow.style.display = ['SIP Registration', 'SIP Installment', 'SWP', 'STP'].includes(type) ? 'flex' : 'none';
            }
            updateTasks();
        }

        function addTransaction() {
            transactionCount++;
            const id = transactionCount;

            let amcOptions = '<option value="">-- Select AMC --</option>';
            amcList.forEach(amc => amcOptions += `<option value="${amc}">${amc}</option>`);

            const html = `
                <div class="transaction-card" data-id="${id}">
                    <div class="transaction-header">
                        <span class="transaction-title">Transaction #${id}</span>
                        <button class="btn-remove" onclick="removeTransaction(${id})">&times;</button>
                    </div>
                    <div class="transaction-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Transaction Type <span class="required">*</span></label>
                                <select id="txnType${id}" onchange="onTxnTypeChange(${id})">
                                    <option value="">-- Select Type --</option>
                                    <option value="Purchase">Purchase</option>
                                    <option value="SIP Registration">SIP Registration</option>
                                    <option value="SIP Installment">SIP Installment</option>
                                    <option value="Redemption">Redemption</option>
                                    <option value="Switch">Switch</option>
                                    <option value="SWP">SWP</option>
                                    <option value="STP">STP</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Amount (INR) <span class="required">*</span></label>
                                <input type="number" id="txnAmount${id}" placeholder="Enter amount" onchange="updateTasks()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>AMC <span class="required">*</span></label>
                                <select id="txnAmc${id}" onchange="onAmcChange(${id})">${amcOptions}</select>
                            </div>
                            <div class="form-group">
                                <label>Scheme Name <span class="required">*</span></label>
                                <input type="text" id="txnScheme${id}" placeholder="Enter scheme name" onchange="updateTasks()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Payout Mode</label>
                                <select id="txnPayout${id}">
                                    <option value="Growth">Growth</option>
                                    <option value="IDCW Payout">IDCW Payout</option>
                                    <option value="IDCW Reinvestment">IDCW Reinvestment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Platform</label>
                                <select id="txnPlatform${id}">
                                    <option value="NSE">NSE</option>
                                    <option value="BSE">BSE</option>
                                    <option value="MFU">MFU</option>
                                    <option value="Direct AMC">Direct AMC</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row" id="sipRow${id}" style="display: none;">
                            <div class="form-group">
                                <label>SIP Date</label>
                                <select id="txnSipDate${id}">
                                    <option value="1">1st</option>
                                    <option value="5">5th</option>
                                    <option value="10">10th</option>
                                    <option value="15">15th</option>
                                    <option value="20">20th</option>
                                    <option value="25">25th</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('transactionsList').insertAdjacentHTML('beforeend', html);
            updateTasks();
        }

        function removeTransaction(id) {
            if (document.querySelectorAll('.transaction-card').length > 1) {
                document.querySelector(`.transaction-card[data-id="${id}"]`).remove();
                updateTasks();
            } else {
                alert('At least one transaction is required');
            }
        }

        // ========================================
        // TASKS
        // ========================================
        function updateTasks() {
            const tasksList = document.getElementById('tasksList');
            let html = '';

            if (!selectedInvestor) {
                tasksList.innerHTML = '<div class="empty-tasks">Select an investor to see tasks</div>';
                return;
            }

            if (isNewInvestor) {
                html += createTaskItem('new', 'Create Investor in CRM', 'Add new investor record', 'high');
            }

            if (selectedInvestor.kycStatus !== 'Validated') {
                const desc = selectedInvestor.kycStatus === 'Registered' ? 'Complete KYC validation' :
                             selectedInvestor.kycStatus === 'On-Hold' ? 'Resolve KYC hold issues' :
                             'Initiate KYC registration';
                html += createTaskItem('kyc', 'Verify KYC', desc, 'high');
            }

            if (!selectedInvestor.nse) html += createTaskItem('platform', 'Onboard to NSE', 'Register on NSE platform');
            if (!selectedInvestor.bse) html += createTaskItem('platform', 'Onboard to BSE', 'Register on BSE platform');
            if (!selectedInvestor.mfu) html += createTaskItem('platform', 'Onboard to MFU', 'Register on MFU platform');

            document.querySelectorAll('.transaction-card').forEach(card => {
                const id = card.dataset.id;
                const type = document.getElementById('txnType' + id)?.value;
                const scheme = document.getElementById('txnScheme' + id)?.value;
                const amount = document.getElementById('txnAmount' + id)?.value;

                if (type) {
                    const typeLabels = {
                        'Purchase': 'Process Purchase', 'SIP Registration': 'Register SIP',
                        'SIP Installment': 'Process SIP Installment', 'Redemption': 'Process Redemption',
                        'Switch': 'Process Switch', 'SWP': 'Register SWP', 'STP': 'Register STP'
                    };
                    html += createTaskItem('txn', typeLabels[type] || type, `${scheme || 'Scheme TBD'} - ₹${amount || '0'}`);
                }
            });

            if (!html) {
                html = '<div class="empty-tasks" style="background: #d4edda; color: #155724; padding: 20px; border-radius: 8px;">✓ No tasks - investor fully onboarded</div>';
            }

            tasksList.innerHTML = html;
        }

        function createTaskItem(type, name, desc, priority = 'normal') {
            const icons = { new: '★', kyc: 'K', platform: 'P', txn: 'T' };
            let userOptions = '<option value="">-- Assign to --</option>';
            crmUsers.forEach(u => userOptions += `<option value="${u.id}">${u.name}</option>`);

            return `
                <div class="task-item" style="${priority === 'high' ? 'border-left-color: #dc3545;' : ''}">
                    <div class="task-icon ${type}">${icons[type]}</div>
                    <div class="task-info">
                        <div class="task-name">${name}${priority === 'high' ? ' <span style="color:#dc3545;font-size:11px;">(HIGH)</span>' : ''}</div>
                        <div class="task-desc">${desc}</div>
                    </div>
                    <div class="task-assign">
                        <select data-task-type="${type}" data-task-name="${name}">${userOptions}</select>
                    </div>
                </div>
            `;
        }

        // ========================================
        // FORM SUBMISSION - CREATE RECORDS IN CRM
        // ========================================
        async function submitForm() {
            if (!selectedInvestor) {
                alert('Please select an investor');
                return;
            }

            if (isNewInvestor) {
                const email = document.getElementById('newInvestorEmail').value.trim();
                const phone = document.getElementById('newInvestorPhone').value.trim();
                if (!email || !phone) {
                    alert('Email and Phone are required for new investors');
                    return;
                }
                selectedInvestor.email = email;
                selectedInvestor.phone = phone;
            }

            const unassigned = Array.from(document.querySelectorAll('.task-assign select')).filter(s => !s.value);
            if (unassigned.length > 0) {
                alert('Please assign all tasks');
                return;
            }

            showLoading("Creating records in Zoho CRM...");

            try {
                const F = CONFIG.fields;
                let investorId = selectedInvestor.id;
                let assignedRmId = null;

                const firstAssignment = document.querySelector('.task-assign select');
                if (firstAssignment && firstAssignment.value) {
                    assignedRmId = firstAssignment.value;
                }

                // Create Investor if new
                if (isNewInvestor) {
                    setLoadingText("Creating investor...");

                    const investorData = {
                        [F.investor.name]: selectedInvestor.name,
                        [F.investor.email]: selectedInvestor.email,
                        [F.investor.phone]: selectedInvestor.phone,
                        [F.investor.pan]: selectedInvestor.pan,
                        [F.investor.kycStatus]: "Not Verified",
                        [F.investor.nseReg]: false,
                        [F.investor.bseReg]: false,
                        [F.investor.mfuReg]: false
                    };

                    const resp = await ZOHO.CRM.API.insertRecord({
                        Entity: CONFIG.modules.investors,
                        APIData: investorData,
                        Trigger: ["workflow"]
                    });

                    if (resp && resp.data && resp.data[0]) {
                        investorId = resp.data[0].details.id;
                        console.log("Created investor:", investorId);
                    }
                }

                // Create Transactions
                setLoadingText("Creating transactions...");
                const txnCards = document.querySelectorAll('.transaction-card');
                const createdTransactions = [];

                for (const card of txnCards) {
                    const id = card.dataset.id;
                    const type = document.getElementById('txnType' + id)?.value;
                    const amount = document.getElementById('txnAmount' + id)?.value;
                    const amc = document.getElementById('txnAmc' + id)?.value;
                    const scheme = document.getElementById('txnScheme' + id)?.value;
                    const payout = document.getElementById('txnPayout' + id)?.value;
                    const platform = document.getElementById('txnPlatform' + id)?.value;
                    const sipDate = document.getElementById('txnSipDate' + id)?.value;

                    if (type && scheme) {
                        const txnData = {
                            [F.transaction.investor]: { id: investorId },
                            [F.transaction.type]: type,
                            [F.transaction.amount]: parseFloat(amount) || 0,
                            [F.transaction.amc]: amc,
                            [F.transaction.scheme]: scheme,
                            [F.transaction.payout]: payout || 'Growth',
                            [F.transaction.platform]: platform || 'NSE',
                            [F.transaction.status]: "Created",
                            [F.transaction.priority]: "Normal",
                            [F.transaction.notes]: document.getElementById('notes').value
                        };

                        if (['SIP Registration', 'SIP Installment', 'SWP', 'STP'].includes(type)) {
                            txnData[F.transaction.sipDate] = sipDate;
                        }

                        const txnResp = await ZOHO.CRM.API.insertRecord({
                            Entity: CONFIG.modules.transactions,
                            APIData: txnData,
                            Trigger: ["workflow"]
                        });

                        if (txnResp && txnResp.data && txnResp.data[0]) {
                            createdTransactions.push({
                                id: txnResp.data[0].details.id,
                                type: type,
                                scheme: scheme
                            });
                            console.log("Created transaction:", txnResp.data[0].details.id);
                        }
                    }
                }

                hideLoading();

                const txnCount = createdTransactions.length;
                const txnList = createdTransactions.map(t => `• ${t.type}: ${t.scheme}`).join('\n');

                alert(`✓ Transaction request submitted successfully!\n\n` +
                    `Records created in Zoho CRM:\n` +
                    `${isNewInvestor ? '• New Investor record\n' : ''}` +
                    `• ${txnCount} Transaction(s):\n${txnList}\n\n` +
                    `Task checklists have been auto-populated.`);

            } catch (error) {
                console.error("Submit error:", error);
                hideLoading();
                alert('Error: ' + (error.message || JSON.stringify(error)));
            }
        }

        function resetForm() {
            location.reload();
        }
    </script>
</body>
</html>
